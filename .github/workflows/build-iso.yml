# Cortex Linux ISO Build Workflow
# Builds and publishes Cortex Linux ISO images
# Copyright 2025 AI Venture Holdings LLC
# SPDX-License-Identifier: Apache-2.0

name: Build ISO

on:
  push:
    branches: [main]
    tags: ['v*']
    paths:
      - 'iso/**'
      - 'branding/**'
      - 'packages/**'
      - 'scripts/**'
      - 'Makefile'
      - '.github/workflows/build-iso.yml'
  pull_request:
    branches: [main]
    paths:
      - 'iso/**'
      - 'branding/**'
      - 'packages/**'
      - 'scripts/**'
      - 'Makefile'
  workflow_dispatch:
    inputs:
      profile:
        description: 'ISO profile to build'
        required: true
        default: 'full'
        type: choice
        options:
          - core
          - full
          - secops
          - all

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-24.04
    container:
      image: debian:bookworm
    steps:
      - name: Install git
        run: |
          apt-get update
          apt-get install -y git sudo shellcheck

      - name: Checkout
        uses: actions/checkout@v4

      - name: Run validation
        run: make validate

  build-branding-package:
    name: Build Branding Package
    runs-on: ubuntu-24.04
    container:
      image: debian:bookworm
    needs: validate
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y git dpkg-dev sudo imagemagick

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build cortex-branding package
        run: make branding-package

      - name: Upload branding package
        uses: actions/upload-artifact@v4
        with:
          name: cortex-branding
          path: output/*.deb
          retention-days: 7

  build-iso:
    name: Build ISO (${{ matrix.profile }})
    runs-on: ubuntu-24.04
    container:
      image: debian:bookworm
      options: --privileged
    needs: [validate, build-branding-package]
    strategy:
      fail-fast: false
      matrix:
        profile: [core, full]
        arch: [amd64]
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git \
            make \
            sudo \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-efi \
            grub-pc-bin \
            grub-efi-amd64-bin \
            mtools \
            dosfstools \
            imagemagick \
            gnupg \
            python3

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download branding package
        uses: actions/download-artifact@v4
        with:
          name: cortex-branding
          path: output/

      - name: Check dependencies
        run: make check-deps

      - name: Build ISO
        run: make iso-${{ matrix.profile }}
        env:
          ARCH: ${{ matrix.arch }}

      - name: List output
        if: always()
        run: |
          ls -la output/ || echo "No output directory"
          ls -la build/${{ matrix.profile }}/ || echo "No build directory"

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: cortex-linux-${{ matrix.profile }}-${{ matrix.arch }}
          path: |
            output/*.iso
            output/*.sha256
          retention-days: 14

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.profile }}-${{ matrix.arch }}
          path: output/sbom/
          retention-days: 14
        continue-on-error: true

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.profile }}-${{ matrix.arch }}
          path: build.log
          retention-days: 7

  test-iso:
    name: Test ISO (${{ matrix.profile }})
    runs-on: ubuntu-24.04
    needs: build-iso
    strategy:
      matrix:
        profile: [core, full]
        arch: [amd64]
    steps:
      - name: Download ISO
        uses: actions/download-artifact@v4
        with:
          name: cortex-linux-${{ matrix.profile }}-${{ matrix.arch }}

      - name: Verify checksums
        run: |
          ls -la
          for iso in *.iso; do
            if [ -f "${iso}.sha256" ]; then
              sha256sum -c "${iso}.sha256"
            fi
          done

      - name: Check ISO structure
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso
          for iso in *.iso; do
            echo "=== Checking $iso ==="
            xorriso -indev "$iso" -find / -maxdepth 1 2>/dev/null | head -20
          done

  release:
    name: Create Release
    runs-on: ubuntu-24.04
    needs: [build-iso, test-iso]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download all ISO artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cortex-linux-*
          merge-multiple: true
          path: release/

      - name: Download branding package
        uses: actions/download-artifact@v4
        with:
          name: cortex-branding
          path: release/

      - name: Download SBOMs
        uses: actions/download-artifact@v4
        with:
          pattern: sbom-*
          merge-multiple: true
          path: release/sbom/
        continue-on-error: true

      - name: Generate combined checksums
        run: |
          cd release
          sha256sum *.iso *.deb > SHA256SUMS
          sha512sum *.iso *.deb > SHA512SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.iso
            release/*.deb
            release/SHA256SUMS
            release/SHA512SUMS
            release/sbom/*
          body: |
            ## Cortex Linux ${{ github.ref_name }}

            ### Downloads
            - **cortex-linux-core-*.iso** - Minimal core system
            - **cortex-linux-full-*.iso** - Full desktop system
            - **cortex-branding_*.deb** - Branding package

            ### Verification
            ```bash
            sha256sum -c SHA256SUMS
            ```

            ### Quick Start
            1. Write ISO to USB: `sudo dd if=cortex-linux-*.iso of=/dev/sdX bs=4M status=progress oflag=sync`
            2. Boot from USB
            3. Select "Live Boot" or "Install"

            ### Documentation
            See https://github.com/cortexlinux/cortex-distro for documentation.
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
