# Cortex Linux ISO Build Workflow
# Builds and publishes Cortex Linux ISO images
# Copyright 2025 AI Venture Holdings LLC
# SPDX-License-Identifier: Apache-2.0

name: Build ISO

on:
  push:
    branches: [main]
    tags: ['v*']
    paths:
      - 'src/**'
      - 'config/**'
      - 'packages/**'
      - 'scripts/**'
      - 'Makefile'
      - '.github/workflows/build-iso.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'config/**'
      - 'packages/**'
      - 'scripts/**'
      - 'Makefile'
  workflow_dispatch:

env:
  DEBIAN_FRONTEND: noninteractive

jobs:

  build-iso:
    name: Build ISO (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Additional cleanup
        run: |
          echo "=== Additional cleanup ==="
          sudo rm -rf /home/runner/.rustup || true
          sudo rm -rf /home/runner/.cargo || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /usr/lib/jvm || true
          sudo rm -rf /usr/local/julia* || true
          sudo rm -rf /usr/local/share/chromium || true
          sudo rm -rf /usr/lib/google-cloud-sdk || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          echo "=== Disk space after additional cleanup ==="
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Ubuntu version
        id: ubuntu-version
        run: |
          UBUNTU_VERSION=$(grep -E '^export TARGET_UBUNTU_VERSION=' src/args.sh | cut -d'"' -f2)
          echo "version=$UBUNTU_VERSION" >> $GITHUB_OUTPUT
          echo "Ubuntu version: $UBUNTU_VERSION"

      - name: Setup debootstrap cache directory
        run: |
          sudo mkdir -p /var/cache/debootstrap
          sudo chmod 755 /var/cache/debootstrap
          echo "Debootstrap cache directory ready"

      - name: Cache debootstrap
        uses: actions/cache@v4
        with:
          path: /var/cache/debootstrap
          key: debootstrap-${{ matrix.arch }}-${{ steps.ubuntu-version.outputs.version }}
          restore-keys: |
            debootstrap-${{ matrix.arch }}-${{ steps.ubuntu-version.outputs.version }}
            debootstrap-${{ matrix.arch }}-

      - name: Build ISO
        run: |
          # Use xz compression for releases (smaller), lz4 for PR/branch builds (faster)
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            COMPRESSION="xz"
          else
            COMPRESSION="lz4"
          fi
          export ARCH=${{ matrix.arch }}
          export SQUASHFS_COMP=$COMPRESSION
          export DEBIAN_FRONTEND=noninteractive
          set -e
          sudo bash scripts/install-deps.sh
          make bootstrap
          make build

      - name: List output
        if: always()
        run: |
          ls -la src/dist/ || echo "No dist directory"
          ls -la image/ || echo "No image directory"

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: cortex-linux-${{ matrix.arch }}
          path: |
            src/dist/*.iso
            src/dist/*.sha256
          retention-days: 14

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.arch }}
          path: build.log
          retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-24.04
    needs: build-iso
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download all ISO artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cortex-linux-*
          merge-multiple: true
          path: release/

      - name: Generate combined checksums
        run: |
          cd release
          sha256sum *.iso > SHA256SUMS
          sha512sum *.iso > SHA512SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.iso
            release/SHA256SUMS
            release/SHA512SUMS
          body: |
            ## Cortex Linux ${{ github.ref_name }}

            ### Downloads
            - **cortex-linux-*.iso** - Cortex Linux ISO

            ### Verification
            ```bash
            sha256sum -c SHA256SUMS
            ```

            ### Quick Start
            1. Write ISO to USB: `sudo dd if=cortex-linux-*.iso of=/dev/sdX bs=4M status=progress oflag=sync`
            2. Boot from USB
            3. Select "Live Boot" or "Install"

            ### Documentation
            See https://github.com/cortexlinux/cortex-distro for documentation.
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}

