# CX Linux Package Build Workflow
# Builds and publishes CX Linux Debian packages
# ISO build temporarily disabled - needs live-build configuration
# Copyright 2025 AI Venture Holdings LLC
# SPDX-License-Identifier: Apache-2.0

name: Build ISO

on:
  push:
    branches: [main]
    tags: ['v*']
    paths:
      - 'packages/**'
      - 'scripts/**'
      - 'Makefile'
      - '.github/workflows/build-iso.yml'
  pull_request:
    branches: [main]
    paths:
      - 'packages/**'
      - 'scripts/**'
      - 'Makefile'
  workflow_dispatch:

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-packages:
    name: Build Debian Packages
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build packages in Debian container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e DEBIAN_FRONTEND=noninteractive \
            debian:bookworm /bin/bash -c '
              set -e
              apt-get update
              apt-get install -y build-essential dpkg-dev devscripts debhelper fakeroot gnupg

              for pkg in cx-archive-keyring cx-core cx-full; do
                echo "Building $pkg..."
                cd /workspace/packages/$pkg
                dpkg-buildpackage -us -uc -b
                cd /workspace
              done

              mkdir -p /workspace/output/packages
              mv /workspace/packages/*.deb /workspace/output/packages/ 2>/dev/null || true
              ls -la /workspace/output/packages/
            '

      - name: Generate checksums
        run: |
          cd output/packages
          sha256sum *.deb > SHA256SUMS
          cat SHA256SUMS

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages
          path: |
            output/packages/*.deb
            output/packages/SHA256SUMS
          retention-days: 14

  release:
    name: Create Release
    runs-on: ubuntu-24.04
    needs: build-packages
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: debian-packages

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.deb
            SHA256SUMS
          body: |
            ## CX Linux ${{ github.ref_name }}

            ### Installation

            **Quick Install (recommended):**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/cxlinux-ai/cx-distro/main/scripts/install.sh | sudo bash
            ```

            **Manual Install:**
            ```bash
            # Download packages
            wget https://github.com/cxlinux-ai/cx-distro/releases/download/${{ github.ref_name }}/cx-archive-keyring_*.deb
            wget https://github.com/cxlinux-ai/cx-distro/releases/download/${{ github.ref_name }}/cx-core_*.deb

            # Install
            sudo dpkg -i cx-archive-keyring_*.deb cx-core_*.deb
            sudo apt-get install -f
            ```

            ### Verification
            ```bash
            sha256sum -c SHA256SUMS
            ```

            ### Documentation
            See https://cxlinux.ai/docs for full documentation.

            ---
            *Note: ISO images will be available in a future release.*
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
