# CX Linux ISO Build Workflow
# Builds and publishes CX Linux ISO images
# Copyright 2025 AI Venture Holdings LLC
# SPDX-License-Identifier: Apache-2.0

name: Build ISO

on:
  push:
    branches: [main]
    tags: ['v*']
    paths:
      - 'iso/**'
      - 'packages/**'
      - 'scripts/**'
      - 'Makefile'
      - '.github/workflows/build-iso.yml'
  pull_request:
    branches: [main]
    paths:
      - 'iso/**'
      - 'packages/**'
      - 'scripts/**'
      - 'Makefile'
  workflow_dispatch:

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-iso:
    name: Build ISO Image
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        arch: [amd64]
    steps:
      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build ISO in Ubuntu container
        run: |
          docker run --rm --privileged \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e ARCH=${{ matrix.arch }} \
            -e DEBIAN_FRONTEND=noninteractive \
            ubuntu:latest /bin/bash -c '
              set -e
              echo "=== Installing basic build tools ==="
              apt-get update
              apt-get install -y make sudo
              
              echo "=== Building ISO using make build ==="
              export ARCH=${{ matrix.arch }}
              # make build will handle dependency installation and build process
              make build 2>&1 | tee /workspace/build.log

              echo "=== Generating checksums ==="
              if ls output/*.iso 1>/dev/null 2>&1; then
                cd output
                sha256sum *.iso > SHA256SUMS
                sha512sum *.iso > SHA512SUMS
                cd ..
              else
                echo "No ISO files generated"
                exit 1
              fi

              echo "=== Output ==="
              ls -la output/
            '

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: cx-linux-${{ matrix.arch }}
          path: |
            output/*.iso
            output/SHA256SUMS
            output/SHA512SUMS
          retention-days: 14

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.arch }}
          path: build.log
          retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-24.04
    needs: build-iso
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download ISO artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cx-linux-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.iso
            SHA256SUMS
            SHA512SUMS
          body: |
            ## CX Linux ${{ github.ref_name }}

            ### Downloads
            - **cx-linux-*-amd64-offline.iso** - Full offline installer

            ### Verification
            ```bash
            sha256sum -c SHA256SUMS
            ```

            ### Quick Start
            1. Write ISO to USB: `dd if=cx-linux-*.iso of=/dev/sdX bs=4M status=progress`
            2. Boot from USB
            3. Follow installation prompts

            ### Documentation
            See https://cxlinux-ai.com/docs for full documentation.
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
