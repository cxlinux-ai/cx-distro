#!/usr/bin/make -f
# CX Core Package Build Rules
# Copyright 2025 AI Venture Holdings LLC
# SPDX-License-Identifier: BUSL-1.1

export DH_VERBOSE=1

%:
	dh $@

override_dh_auto_build:
	@echo "No build step required - cx-linux installed via pip"

override_dh_auto_install:
	# Create configuration directories
	install -d $(CURDIR)/debian/cx-core/etc/cx
	install -d $(CURDIR)/debian/cx-core/etc/cx/profiles.d
	install -d $(CURDIR)/debian/cx-core/var/lib/cx
	install -d $(CURDIR)/debian/cx-core/var/log/cx
	install -d $(CURDIR)/debian/cx-core/var/cache/cx
	install -d $(CURDIR)/debian/cx-core/usr/share/cx
	install -d $(CURDIR)/debian/cx-core/usr/share/doc/cx-core
	install -d $(CURDIR)/debian/cx-core/usr/bin

	# Install default configuration
	install -m 644 debian/cx.yaml \
		$(CURDIR)/debian/cx-core/etc/cx/cx.yaml

	# Create cx wrapper that installs from PyPI on first run
	echo '#!/bin/bash' > $(CURDIR)/debian/cx-core/usr/bin/cx
	echo '# CX Linux CLI Wrapper' >> $(CURDIR)/debian/cx-core/usr/bin/cx
	echo 'if ! python3 -c "import cx" 2>/dev/null; then' >> $(CURDIR)/debian/cx-core/usr/bin/cx
	echo '    echo "Installing cx-linux from PyPI..."' >> $(CURDIR)/debian/cx-core/usr/bin/cx
	echo '    pip3 install --user cx-linux' >> $(CURDIR)/debian/cx-core/usr/bin/cx
	echo 'fi' >> $(CURDIR)/debian/cx-core/usr/bin/cx
	echo 'python3 -m cx.cli "$$@"' >> $(CURDIR)/debian/cx-core/usr/bin/cx
	chmod 755 $(CURDIR)/debian/cx-core/usr/bin/cx

override_dh_auto_clean:
	@echo "No clean step required"
