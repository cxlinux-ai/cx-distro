#!/bin/bash
#
# Cortex Branding Post-Installation Script
#

set -e

case "$1" in
    configure)
        # Set Plymouth theme
        if command -v plymouth-set-default-theme &>/dev/null; then
            plymouth-set-default-theme cortex || true
            update-initramfs -u || true
        fi

        # Update GRUB theme
        if [ -f /etc/default/grub ]; then
            if ! grep -q "GRUB_THEME=" /etc/default/grub; then
                echo 'GRUB_THEME="/boot/grub/themes/cortex/theme.txt"' >> /etc/default/grub
            else
                sed -i 's|^GRUB_THEME=.*|GRUB_THEME="/boot/grub/themes/cortex/theme.txt"|' /etc/default/grub
            fi
            if command -v update-grub &>/dev/null; then
                update-grub
            fi
        fi

        # Set MOTD scripts executable
        if [ -d /etc/update-motd.d ]; then
            for script in 00-cortex-banner 10-cortex-sysinfo 20-cortex-updates 99-cortex-footer; do
                [ -f "/etc/update-motd.d/$script" ] && chmod +x "/etc/update-motd.d/$script"
            done

            # Disable default Ubuntu/Debian MOTD scripts
            for f in /etc/update-motd.d/??-* ; do
                case "$(basename "$f")" in
                    *cortex*) ;;  # Keep our scripts
                    *) [ -f "$f" ] && chmod -x "$f" ;;
                esac
            done
        fi

        # Update GDM branding
        if [ -f /etc/gdm3/greeter.dconf-defaults ] && command -v dconf &>/dev/null; then
            dconf update
        fi

        # Set wallpaper as default
        if [ -d /usr/share/gnome-background-properties ]; then
            # Wallpapers are automatically available to users
            echo "Cortex wallpapers installed."
        fi

        echo "Cortex Linux branding installed successfully."
        echo "Some changes may require a reboot to take effect."
        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        ;;

    *)
        echo "postinst called with unknown argument '$1'" >&2
        exit 1
        ;;
esac

exit 0
